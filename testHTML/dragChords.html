<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <!-- midi.js package -->
 <script src="/m21j/ext/midijs/js/MIDI/AudioDetect.js" type="text/javascript"></script>
 <script src="/m21j/ext/midijs/js/MIDI/LoadPlugin.js" type="text/javascript"></script>
 <script src="/m21j/ext/midijs/js/MIDI/Plugin.js" type="text/javascript"></script>
 <script src="/m21j/ext/midijs/js/MIDI/Player.js" type="text/javascript"></script>
 <script src="/m21j/ext/midijs/js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
 <script src="/m21j/ext/midijs/js/Window/DOMLoader.script.js" type="text/javascript"></script>
 <!-- extras -->
 <script src="/m21j/ext/midijs/inc/Base64.js" type="text/javascript"></script>
 <script src="/m21j/ext/midijs/inc/base64binary.js" type="text/javascript"></script>
 <!-- vexflow -->
 <script src='http://code.jquery.com/jquery-latest.js'></script>
 <script src='http://www.vexflow.com/support/vexflow-min.js'></script>
 <!-- music21j -->
 <script src="/m21j/music21.js" type="text/javascript"></script>
 <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>

 <link rel="stylesheet" href="http://web.mit.edu/music21/doc/_static/m21.css" type="text/css" />
 <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700" type="text/css" />

</head>
<body>
<script type="text/javascript">

var stopIntervalId;
var numPlays = 0;
var playedNote = 70;


function refreshMe() {
    stopIntervalId = setInterval(playSeventy, 100);
}

function drawME() {
	var myNote = new Music21.Rest(4.0);
    var myStream = new Music21.Stream();
    myStream.append(myNote);
	myStream.appendNewCanvas();
}

var allStream;

window.onload = function () {
	MIDI.loadPlugin({
		soundfontUrl: "/m21j/ext/midijs/soundfont/",
		instrument: "acoustic_grand_piano",
		callback: function() {
			var delay = 0; // play one note every quarter second
			var note = 50; // the MIDI note
			var velocity = 127; // how hard the note hits
			// play the note
			MIDI.setVolume(0, 127);
			MIDI.noteOn(0, note, velocity, delay);
			MIDI.noteOff(0, note, delay + 0.75);
			//var thisInt = new Music21.GenericInterval(-10);
			//alert (thisInt.reverse().directed);
		}
	});
	renderThemes();
	allStream = new Music21.Part();
	var newCanvas = allStream.createPlayableCanvas();
	$('#dropDiv canvas').replaceWith(newCanvas[0]);	

};

function renderThemes ()  {
    var chords = ["C2 E2 G2", "F#2 C#3 A3", "B2 F3 D#4"];
    var chordCanvases = [];
    for (var i = 0; i < chords.length; i++) {
        var thisChordArr = chords[i].split(" ");
        console.log(thisChordArr);
        var thisChord = new Music21.Chord(thisChordArr);
		thisChord.duration.type = 'whole';
        var myStream = new Music21.Stream();
        myStream.clef = new Music21.Clef('bass');
        myStream.append(thisChord)
        var nc = myStream.createPlayableCanvas();
        $('#themeDiv').append(nc);
        nc.draggable( {
		  containment: 'body',
		  stack: '#themeDiv canvas',
		  cursor: 'move',
		  revert: true} ).data('stream', myStream);
		nc[0].ondblclick = nc[0].onclick;
		nc[0].onclick = undefined;
        chordCanvases.push(nc[0]);
        if (i % 5 == 4) {
            $('#themeDiv').append($('<br/>'));
            // alert(nc);
		}
    }
	$('body').append($('<br/>'))
	$('.dropAccepts').droppable( {
      accept: '#themeDiv canvas',
      hoverClass: 'hovered',
      drop: handleThemeDrop
    } );

	// themeCanvases[0].style.display = 'none';
}

function handleThemeDrop(event, ui) {
    var containedStream = ui.draggable.data('stream');
	var soughtType = $(this).attr('type');
    console.log('looking for: ' + soughtType);
	var thisChord = containedStream._elements[0];
	var foundCorrect = false;
	if (soughtType == 'major') {
		if (thisChord.isMajorTriad()) {
			foundCorrect = true;
		}
	} else if (soughtType == 'minor') {
		if (thisChord.isMinorTriad()) {
			foundCorrect = true;
		}
	} else if (soughtType == 'other') {
		if (thisChord.isMinorTriad() == false && thisChord.isMajorTriad() == false) {
			foundCorrect = true;
		}
	}
	console.log("FoundCorrect: " + foundCorrect);
	// alert(allStream.hi);
}

function clearScore() {
	allStream._elements = [];
	var newCanvas = allStream.createPlayableCanvas();
	$('#dropDiv canvas').replaceWith(newCanvas[0]);
}

function undoAdd() {
	allStream._elements = allStream._elements.slice(0, allStream._elements.length - 1);
	var newCanvas = allStream.createPlayableCanvas();
	$('#dropDiv canvas').replaceWith(newCanvas[0]);	
}

</script>
<style>
.dropAccepts {
	display: table-cell !important;
	width: 150px;
	height: 150px;
	text-align: center;
    vertical-align:middle;
	border: 15px gray dashed;
	-moz-border-radius: 15px;
    -webkit-border-radius: 15px;
    -khtml-border-radius: 15px;
    border-radius: 15px;
    float: left;
    margin-right: 80px;
    font-size: 30px;
    color: gray;
    line-height: 35px;
    background-color: rgba(221, 221, 20, .2)
}
</style>
<div class="body">
	<h1>Double Click me to play!</h1>
	<div id="dragContent">
		<div id="themeDiv"></div>
		<div id="dropDiv" height="800" width="1200">
			<h1>Drop here! then single click to play</h1>
			<button onclick="clearScore()">Clear</button> ... <button onclick="undoAdd()">Undo</button><br></br>
			<div style="display: table">
				<div class="dropAccepts" type='major'>Drop <i>Major</i> Chords Here</div>
				<div class="dropAccepts" type='minor'>Drop <i>Minor</i> Chords Here</div>
				<div class="dropAccepts" type='other'>Drop <i>Other</i> Chords Here</div>
			</div>
			<br clear="all"/>
		</div>
	</div>
</div>
</body>
</html>