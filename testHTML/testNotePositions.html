<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
 <title>21M.051 Note changer</title>
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <!-- for MSIE 10 on Windows 8 -->
 <meta http-equiv="X-UA-Compatible" content="requiresActiveX=true"/>
 <!-- midi.js package -->
 <script src="ext/midijs/js/MIDI/AudioDetect.js" type="text/javascript"></script>
 <script src="ext/midijs/js/MIDI/LoadPlugin.js" type="text/javascript"></script>
 <script src="ext/midijs/js/MIDI/Plugin.js" type="text/javascript"></script>
 <script src="ext/midijs/js/MIDI/Player.js" type="text/javascript"></script>
 <script src="ext/midijs/js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
 <script src="ext/midijs/js/Window/DOMLoader.script.js" type="text/javascript"></script>
 <!-- extras -->
 <script src="ext/midijs/inc/Base64.js" type="text/javascript"></script>
 <script src="ext/midijs/inc/base64binary.js" type="text/javascript"></script>
 <!-- vexflow -->
 <script src='http://code.jquery.com/jquery-latest.js'></script>
 <script src='http://www.vexflow.com/support/vexflow-min.js'></script>

 <!-- jQuery UI for drag and drop... -->
 <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js" type="text/javascript" ></script>

 <!-- music21j -->
 <script src="music21j.js" type="text/javascript"></script>
 
 <!-- music21theory -->
 <script src="music21theory.js" type="text/javascript"></script>
 <link rel="stylesheet" href="http://web.mit.edu/music21/doc/_static/m21.css" type="text/css" />
 <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700" type="text/css" />

<style>
.lightInput { border: 1px gray dotted;
			  background-color: #ffffcc;
			   }
.unanswered { background-color: #ffffbb; 
			  opacity: .7;
}
.correct    { background-color: #bbffbb; }
.incorrect  { background-color: #ffbbbb; }

</style>

</head>
<body>

<script>
function canvasChanger (e) {
	var offset = $(this).offset();
	var scaling = $(this).height() / 150; // vexflow default...SINGLE staff only!
	// mouse event handler code from: http://diveintohtml5.org/canvas.html
	var xClick, yClick;
	if (e.pageX != undefined && e.pageY != undefined) {
		xClick = e.pageX;
		yClick = e.pageY;
	} else { 
		xClick = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
		yClick = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
	}
	var xPx = (xClick - offset.left) / scaling;
	var yPx = (yClick - offset.top) / scaling;
	
	var ss = this.storedStream;
	var foundNote;
	for (var i = 0; i < ss._elements.length; i ++) {
		var n = ss._elements[i];
		if (xPx > (n.x - 10) && xPx < (n.x + 10)) {
			foundNote = n;
			break; // O(n); can be made O(log n)
		}
	}
	if (foundNote) {
		var newDiatonicNoteNum = ss.clef.firstLine - Math.round((yPx - 80)/5);
		console.log(n.x + " " + n.pitch.name + " " + xPx + " ; y: " + yPx + " new: " + newDiatonicNoteNum);
		p = new Music21.Pitch("C");
		p.diatonicNoteNum = newDiatonicNoteNum;
		p.accidental = n.pitch.accidental;
		n.pitch = p;
		n.stemDirection = undefined;
		ss.clef.setStemDirection(n);
		console.log(n.x + " " + n.pitch.name + " " + xPx + " ; y: " + yPx + " new: " + newDiatonicNoteNum);
		ss.activeNote = n;
		redrawCanvas();
	} else {
		console.log(xPx);		
	}
}
var s;

function redrawCanvas () {
	var canv = s.replaceLastCanvas("#editable", {height: '200px', width: 'auto'} );	
	canv.onclick = canvasChanger;
}

window.onload = function () {	
	MIDI.loadPlugin({
		soundfontUrl: "/m21j/ext/midijs/soundfont/",
		instrument: "acoustic_grand_piano",
		callback: function() {
			M21Theory.playMotto();
			startTime = new Date().getTime();
		}
	});
	renderTinyNotation();

	s = Music21.TinyNotation("g4 a4 b4 c'4");
	s.autoBeam = false;
	$("#playme").click ( function () { s.playStream() } );

	redrawCanvas();
}

function addAccidental (alter) {
	if (s.activeNote != undefined) {
		n = s.activeNote;
		n.pitch.accidental = new Music21.Accidental(alter);
		redrawCanvas();
	}
}

function renderTinyNotation() {
	var allTNDivs = $(".tinyNotation");
	for (var i = 0 ; i < allTNDivs.length ; i ++) {
		var thisTN = allTNDivs[i];
		var thisTNContents = thisTN.innerText;
		if (String.prototype.trim != undefined) {
			thisTNContents = thisTNContents.trim(); // remove leading, trailing whitespace
		}
		if (thisTNContents != "") {
			var st = Music21.TinyNotation(thisTNContents);
			var newCanvas = st.createPlayableCanvas();
			$(thisTN).attr("tinyNotationContents", thisTNContents);
			$(thisTN).empty()
			$(thisTN).append(newCanvas);
			console.log(thisTNContents);		
		}
	}
}

</script>
<h1>Click to play or add accidentals</h1>
<div>
<button id="playme" />play</button>
<button onClick="addAccidental(-1)"/>♭</button>
<button onClick="addAccidental(0)"/>♮</button>
<button onClick="addAccidental(1)"/>♯</button>

</div>
<h2>Click to alter pitches in the score</h2>
<div id="editable">
<canvas />
</div>

<h2>Just testing down here -- automatic rendering of TinyNotation</h2>
<div class="tinyNotation">c4 d8 e8 f2</div>
<div class="tinyNotation">d8. f#16 e8 f g a</div>
<div class="tinyNotation">   </div>

</body>
</html>
